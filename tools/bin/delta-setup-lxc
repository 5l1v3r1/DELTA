#!/bin/bash
#
# Script to setup single-machine DELTA environment on Ubuntu 14.04
#

# check if an ssh key exists

if ! [ -f ~/.ssh/id_rsa.pub ]
then
    echo "Missing ssh key, please execute 'ssh-keygen -t rsa' to generate a key"
    exit 1
fi


# install LXC
sudo apt-get update > /dev/null
sudo apt-get install lxc bridge-utils -y > /dev/null


# configure lxc default lxcbr0, only if haven't done so
if ! grep -q DELTA "/etc/default/lxc-net" ; then
sudo cp /etc/default/lxc-net /etc/default/lxc-net.bak
echo "
# DELTA lxc config
USE_LXC_BRIDGE="true"

LXC_BRIDGE="deltabr0"
LXC_ADDR="192.168.111.1"
LXC_NETMASK="255.255.255.0"
LXC_NETWORK="192.168.111.0/24"
LXC_DHCP_RANGE="192.168.111.2,192.168.111.254"
LXC_DHCP_MAX="253"
" | sudo tee /etc/default/lxc-net > /dev/null
fi


# add additional lxc bridge interface if not have done so
if ! grep -q deltabr1 "/etc/rc.local"; then
sudo cp /etc/rc.local /etc/rc.local.bak
echo "
brctl addbr deltabr1
ifconfig deltabr1 192.168.222.1/24 up
exit 0
" | sudo tee /etc/rc.local > /dev/null
fi
sudo brctl addbr deltabr1
sudo ifconfig deltabr1 192.168.222.1/24 up


# change default lxc config to have two network interfaces, if not done so

if ! grep -q deltabr1 "/etc/lxc/default.conf" ; then
sudo cp /etc/lxc/default.conf /etc/lxc/default.conf.bak
echo "
lxc.network.type = veth
lxc.network.link = deltabr0
lxc.network.flags = up
lxc.network.hwaddr = 00:16:3e:xx:xx:xx

lxc.network.type = veth
lxc.network.link = deltabr1
lxc.network.flags = up
lxc.network.hwaddr = 00:16:3e:xx:xx:xx
" | sudo tee --append /etc/lxc/default.conf > /dev/null
fi

# restart lxc service to make the config changes effective
sudo service lxc restart

# create one container - controller
sudo lxc-create -n controller -t ubuntu -- --release trusty --auth-key ~/.ssh/id_rsa.pub

# start the container
sudo lxc-start -n controller -d
sleep 5

# install Java8 to the container
sudo lxc-attach -n controller -- bash -c 'echo debconf shared/accepted-oracle-license-v1-1 select true | debconf-set-selections'
sudo lxc-attach -n controller -- bash -c 'echo debconf shared/accepted-oracle-license-v1-1 seen true | debconf-set-selections'
sudo lxc-attach -n controller -- apt-get install software-properties-common -y
sudo lxc-attach -n controller -- add-apt-repository ppa:webupd8team/java -y
sudo lxc-attach -n controller -- apt-get update
sudo lxc-attach -n controller -- apt-get install oracle-java8-installer oracle-java8-set-default -y
sudo lxc-stop -n controller

# wait for 3 sec
sleep 3

# clone containers
sudo lxc-clone -o controller -n channel
sudo lxc-clone -o controller -n mininet

# power-up all containers
declare -a arr=("controller" "channel" "mininet")
for CONTAINER in "${arr[@]}"
do
    sudo lxc-start -n $CONTAINER -d
done

sleep 5

# patch /etc/network/interfaces to assign static ips for each container
sudo lxc-attach -n controller -- bash -c 'echo "auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 192.168.111.11
netmask 255.255.255.0
network 192.168.111.0
broadcast 192.168.111.255
gateway 192.168.111.1
dns-nameservers 8.8.8.8

auto eth1
iface eth1 inet static
address 192.168.222.11
netmask 255.255.255.0
network 192.168.222.0
broadcast 192.168.222.255
dns-nameservers 8.8.8.8
" > /etc/network/interfaces'

sudo lxc-attach -n channel -- bash -c 'echo "auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 192.168.111.12
netmask 255.255.255.0
network 192.168.111.0
broadcast 192.168.111.255
gateway 192.168.111.1
dns-nameservers 8.8.8.8

auto eth1
iface eth1 inet static
address 192.168.222.12
netmask 255.255.255.0
network 192.168.222.0
broadcast 192.168.222.255
dns-nameservers 8.8.8.8
" > /etc/network/interfaces'

sudo lxc-attach -n mininet -- bash -c 'echo "auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 192.168.111.13
netmask 255.255.255.0
network 192.168.111.0
broadcast 192.168.111.255
gateway 192.168.111.1
dns-nameservers 8.8.8.8

auto eth1
iface eth1 inet static
address 192.168.222.13
netmask 255.255.255.0
network 192.168.222.0
broadcast 192.168.222.255
dns-nameservers 8.8.8.8
" > /etc/network/interfaces'


# restart the containers
for CONTAINER in "${arr[@]}"
do
    sudo lxc-stop -n $CONTAINER -r
done

sleep 5

sudo lxc-ls --fancy

#echo "Please execute delta-push-keys to enable passwordless login"
#echo "Then, ssh into each container and enable passwordless sudo"
#echo "Finally, in each container, execute delta-install-requirements to install Java"

